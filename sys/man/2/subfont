.TH SUBFONT 2
.SH NAME
allocsubfont, freesubfont, installsubfont, lookupsubfont, uninstallsubfont, subfontname, readsubfont, readsubfonti, writesubfont, stringsubfont, strsubfontwidth, mkfont \- subfont manipulation
.SH SYNOPSIS
.B #include <u.h>
.br
.B #include <libc.h>
.br
.B #include <draw.h>
.PP
.ta \w'\fLSubfont* 'u
.B
Subfont*	allocsubfont(char *name, int n, int height, int ascent,
.br
.B
	Fontchar *info, Image *i)
.PP
.B
void	freesubfont(Subfont *f)
.PP
.B
void	installsubfont(char *name, Subfont *f)
.PP
.B
Subfont*	lookupsubfont(Subfont *f)
.PP
.B
void	uninstallsubfont(Subfont *f)
.PP
.B
Subfont*	readsubfont(Display *d, char *name, int fd, int dolock)
.PP
.B
Subfont*	readsubfonti(Display *d, char *name, int fd, Image *im,
.br
.B
	  int dolock)
.PP
.B
int	writesubfont(int fd, Subfont *f)
.PP
.B
Point	stringsubfont(Image *dst, Point p, Image *src,
.br
.B
	Subfont *f, char *str)
.PP
.B
Point	strsubfontwidth(Subfont *f, char *s)
.PP
.B
Font*	mkfont(Subfont *f, Rune min)
.SH DESCRIPTION
.B "Understanding Subfonts"
.PP
Subfonts are the building blocks of Plan 9's font system. While a complete
.I font
describes how to display all the characters you might need, a 
.I subfont
contains the actual bitmap images for a specific range of characters.
.PP
Think of it this way:
.IP \(bu 3
A 
.B font
is like a book's table of contents - it tells you where to find things
.IP \(bu
A
.B subfont
is like a chapter - it contains the actual content (character images)
.PP
This separation allows Plan 9 to efficiently handle large character sets like
Unicode by loading only the character ranges you actually use.
.PP
.B "Subfont Structure"
.PP
Every subfont contains:
.IP "1." 4
.B "Character images"
- A bitmap showing all characters side by side
.IP "2."
.B "Metrics data"  
- Information about each character's size and positioning
.IP "3."
.B "Font properties"
- Overall height, ascent, and character count
.PP
Subfonts are the components of fonts that hold the character images.
A font comprises an array of subfonts; see
.IR cachechars (2)
for the detailed technical implementation.
.PP
.B "Creating and Managing Subfonts"
.PP
.B Subfont
is created and initialized with
.IR allocsubfont .
This function takes several parameters that define the subfont:
.TP
.B name
Identifies the subfont in the cache system
.TP
.B n
Number of characters in this subfont
.TP
.B height  
Total character height in pixels
.TP
.B ascent
Distance from top of character to baseline
.TP
.B info
Array of character metrics (see
.IR cachechars (2)
for the 
.B Fontchar
structure)
.TP
.B i
Image containing all character bitmaps
.PP
The function registers the image as a subfont with the graphics system and
returns a pointer to the new
.B Subfont
structure, or 0 on failure.
.PP
.B "Memory Management"
.PP
.I Freesubfont
frees a subfont and all its associated structures, including the
associated image. 
.B Important:
Since
.I freesubfont
calls
.I free
on the
.BR f->info
field, if this field was not allocated by
.IR malloc (2)
(for example, if it points to static data), you should set it to zero 
before calling
.IR freesubfont
to avoid memory corruption.
.PP
A number of subfonts are kept in external files.
The convention for naming subfont files is:
.IP
.B /lib/font/bit/\fIname\fP/\fIclass\fP.\fIsize\fP.\fIdepth
.PD
.PP
where
.I size
is approximately the height in pixels of the lower case letters
(without ascenders or descenders).
If there is only one version of the subfont, the
.BI \&. depth
extension is elided.
.I Class
describes the range of runes encoded in the subfont:
.BR ascii ,
.BR latin1 ,
.BR greek ,
etc.
.PP
Subfonts are cached within the program, so a subfont shared between fonts will be loaded only once.
.I Installsubfont
stores subfont
.I f
under the given
.IR name ,
typically the file name from which it was read.
.I Uninstallsubfont
removes the subfont from the cache.
Finally,
.I lookupsubfont
searches for  a subfont with the given
.I name
in the cache and returns it, or nil if no such subfont exists.
.PP
.I Subfontname
is used to locate subfonts given their names within the fonts.
The default version constructs a name given the
.IR cfname ,
its name within the font,
.IR fname ,
the name of the font, and the maximum depth suitable for this subfont.
This interface allows a partially specified name within a font to be resolved
at run-time to the name of a file holding a suitable subfont.
Although it is principally a routine internal to the library,
.I subfontname
may be substituted by the application to provide a less file-oriented subfont naming scheme.
.PP
The format of a subfont file is described in
.IR font (6).
Briefly, it contains a image with all the characters in it,
followed by a subfont header, followed by character information.
.I Readsubfont
reads a subfont from the file descriptor
.IR fd .
The
.I name
is used to identify the font in the cache.
The
.I dolock
argument specifies whether the routine should synchronize
use of the
.I Display
with other processes; for single-threaded applications it may
always be zero.
.I Readsubfonti
does the same for a subfont whose associated image is already in memory; it is passed as the
argument
.IR im .
In other words,
.I readsubfonti
reads only the header and character information from the file descriptor.
.PP
.I Writesubfont
writes on
.I fd
the part of a subfont file that comes after the image.  It should be preceded by
a call to
.IR writeimage
(see
.IR allocimage (2)).
.PP
.I Stringsubfont
is analogous to
.B string
(see
.IR draw (2))
for subfonts.  Rather than use the underlying font caching primitives,
it calls
.B draw
for each character.
It is intended for stand-alone environments such as operating system kernels.
.I Strsubfontwidth
returns the width of the string
.I s
in
as it would appear if drawn with
.I stringsubfont
in
.B Subfont
.BR f .
.PP
.I Mkfont
takes as argument a
.B Subfont
.I s
and returns a pointer to a 
.B Font
that maps the character images in
.I s
into the
.B Runes
.I min
to
.IB min + s ->n-1\f1.
.SH FILES
.TF /lib/font/bit
.TP
.B /lib/font/bit
bitmap font file tree
.SH SOURCE
.B /sys/src/libdraw
.SH SEE ALSO
.IR graphics (2),
.IR allocimage (2),
.IR draw (2),
.IR cachechars (2),
.IR image (6),
.IR font (6)
.SH DIAGNOSTICS
All of the functions use the graphics error function (see
.IR graphics (2)).
